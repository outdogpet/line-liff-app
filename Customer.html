<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員資料維護</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f5f5f5; padding: 20px; }
        .container { background: white; max-width: 500px; margin: 0 auto; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h3 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        
        .required-mark { color: #e74c3c; margin-left: 3px; }
        
        .form-control, .form-select { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; 
            box-sizing: border-box; font-size: 16px; background-color: #fff;
            -webkit-appearance: none; appearance: none; min-height: 44px;
        }

        .readonly-input {
            background-color: #eeeeee !important;
            color: #666;
            cursor: not-allowed;
        }
        
        .form-select {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
        }
        
        .address-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .address-row select { width: 50%; }

        input[type="date"].form-control { line-height: 1.4; display: block; }
        textarea.form-control { resize: vertical; height: 80px; }

        .checkbox-item { 
            display: flex; 
            align-items: center; 
            background: #f0fdf4; 
            padding: 15px; 
            border-radius: 5px; 
            border: 1px solid #c8e6c9; 
            cursor: pointer;
            margin-top: 15px;
        }
        .checkbox-item input { margin-right: 15px; width: 22px; height: 22px; accent-color: #06c755; }
        .checkbox-item label { margin: 0; cursor: pointer; color: #2e7d32; font-weight: bold; }

        .btn { width: 100%; padding: 12px; background-color: #06c755; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; font-weight: bold; margin-top: 20px;}
        .btn:disabled { background-color: #ccc; }
        
        #loading { text-align: center; margin-top: 50px; font-size: 18px; color: #666; }
        #form-area { display: none; }

        /* --- 自定義彈窗樣式 --- */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            width: 80%;
            max-width: 300px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .modal-content p {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }
        .modal-btn {
            background-color: #06c755;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="loading">正在讀取會員資料...</div>

    <div id="form-area" class="container">
        <h3>會員資料維護</h3>
        
        <div class="form-group">
            <label>客戶名稱<span class="required-mark">*</span></label>
            <input type="text" id="u_name" class="form-control readonly-input" readonly placeholder="讀取中...">
        </div>

        <div class="form-group">
            <label>電話<span class="required-mark">*</span></label>
            <input type="tel" id="u_phone" class="form-control" placeholder="09xx-xxx-xxx">
        </div>

        <div class="form-group">
            <label>地址<span class="required-mark">*</span> (縣市/區域必填)</label>
            <div class="address-row">
                <select id="addr_city" class="form-select" onchange="updateDistricts()">
                    <option value="">請選擇縣市</option>
                </select>
                <select id="addr_dist" class="form-select">
                    <option value="">請選擇區域</option>
                </select>
            </div>
            <input type="text" id="addr_detail" class="form-control" placeholder="請輸入街道巷弄號樓...">
        </div>

        <div class="form-group">
            <label>Email</label>
            <input type="email" id="u_email" class="form-control" placeholder="例如：example@gmail.com">
        </div>

        <div class="form-group">
            <label>生日</label>
            <input type="date" id="u_birthday" class="form-control">
        </div>

        <div class="form-group">
            <label>備註</label>
            <textarea id="u_memo" class="form-control" placeholder="備註事項..."></textarea>
        </div>

        <div class="form-group checkbox-item" onclick="document.getElementById('u_marketing').click();">
            <input type="checkbox" id="u_marketing" checked onclick="event.stopPropagation();">
            <label for="u_marketing">願意接收門市優惠與促銷訊息</label>
        </div>

        <button id="btn-save" class="btn" onclick="saveData()">存檔</button>
    </div>

    <div id="myModal" class="custom-modal">
        <div class="modal-content">
            <p id="modal-message">訊息內容</p>
            <button class="modal-btn" onclick="closeAndExit()">確定</button>
        </div>
    </div>

    <script>
        const MY_LIFF_ID = '2009076774-iFPf2YqP'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxzciNP_1cdq9XBnfcgTj5gv_QEt2xk-cevUsocHJx5j4IxjhJvS9DHHz1hhPXzDQHl/exec';
                         
        let currentUserId = '';

        const taiwanData = {
            "基隆市": ["仁愛區", "信義區", "中正區", "中山區", "安樂區", "暖暖區", "七堵區"],
            "台北市": ["中正區", "大同區", "中山區", "松山區", "大安區", "萬華區", "信義區", "士林區", "北投區", "內湖區", "南港區", "文山區"],
            "新北市": ["板橋區", "中和區", "永和區", "新店區", "三重區", "新莊區", "土城區", "樹林區", "三峽區", "鶯歌區", "蘆洲區", "五股區", "泰山區", "林口區", "淡水區", "汐止區", "瑞芳區"],
            "桃園市": ["桃園區", "中壢區", "平鎮區", "八德區", "楊梅區", "蘆竹區", "大溪區", "龜山區", "大園區", "觀音區", "新屋區", "龍潭區"],
            "新竹市": ["東區", "北區", "香山區"],
            "新竹縣": ["竹北市", "竹東鎮", "新埔鎮", "關西鎮", "湖口鄉", "新豐鄉", "芎林鄉", "橫山鄉", "北埔鄉", "寶山鄉"],
            "台中市": ["中區", "東區", "南區", "西區", "北區", "北屯區", "西屯區", "南屯區", "太平區", "大里區", "霧峰區", "烏日區", "豐原區", "后里區", "潭子區", "大雅區", "神岡區"],
            "台南市": ["中西區", "東區", "南區", "北區", "安平區", "安南區", "永康區", "歸仁區", "新化區", "左鎮區", "玉井區", "楠西區", "南化區", "仁德區", "關廟區", "龍崎區", "官田區", "麻豆區", "佳里區"],
            "高雄市": ["新興區", "前金區", "苓雅區", "鹽埕區", "鼓山區", "旗津區", "前鎮區", "三民區", "楠梓區", "小港區", "左營區", "仁武區", "大社區", "岡山區", "路竹區", "鳳山區", "大寮區", "林園區"]
        };

        window.onload = function() {
            initCitySelect();
            initializeLiff();
        };

        function initCitySelect() {
            const citySelect = document.getElementById("addr_city");
            for (let city in taiwanData) {
                let option = document.createElement("option");
                option.value = city;
                option.text = city;
                citySelect.appendChild(option);
            }
        }

        function updateDistricts() {
            const citySelect = document.getElementById("addr_city");
            const distSelect = document.getElementById("addr_dist");
            const city = citySelect.value;
            distSelect.innerHTML = '<option value="">請選擇區域</option>';
            if (city && taiwanData[city]) {
                const dists = taiwanData[city];
                for (let dist of dists) {
                    let option = document.createElement("option");
                    option.value = dist;
                    option.text = dist;
                    distSelect.appendChild(option);
                }
            }
        }

        function initializeLiff() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    liff.getProfile().then(profile => {
                        currentUserId = profile.userId;
                        checkUserStatus(currentUserId, profile.displayName);
                    });
                }
            }).catch(err => { console.error('LIFF 初始化失敗', err); });
        }

        function checkUserStatus(userId, defaultName) {
            const url = GAS_URL + '?action=query&u_id=' + userId;
            fetch(url).then(res => res.json()).then(result => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('form-area').style.display = 'block';
                
                if (result.status === 'exist') {
                    let data = result.data;
                    document.getElementById('u_name').value = data.name;
                    document.getElementById('u_phone').value = data.phone;
                    document.getElementById('u_birthday').value = data.birthday;
                    document.getElementById('u_memo').value = data.memo; 
                    document.getElementById('u_email').value = data.email || ''; 
                    document.getElementById('u_marketing').checked = (data.marketing == 1);
                    
                    parseAndSetAddress(data.addr);
                } else {
                    document.getElementById('u_name').value = defaultName;
                    document.getElementById('u_marketing').checked = true; 
                }
            }).catch(err => { 
                document.getElementById('loading').innerText = '讀取失敗'; 
                console.error('連線錯誤', err); 
            });
        }

        function parseAndSetAddress(fullAddr) {
            if (!fullAddr) return;
            const citySelect = document.getElementById("addr_city");
            let matchedCity = "";
            for (let city in taiwanData) {
                if (fullAddr.startsWith(city)) { matchedCity = city; break; }
            }
            if (matchedCity) {
                citySelect.value = matchedCity;
                updateDistricts();
                const distSelect = document.getElementById("addr_dist");
                let matchedDist = "";
                let remainingAddr = fullAddr.substring(matchedCity.length);
                const dists = taiwanData[matchedCity];
                for (let dist of dists) {
                    if (remainingAddr.startsWith(dist)) { matchedDist = dist; break; }
                }
                if (matchedDist) {
                    distSelect.value = matchedDist;
                    document.getElementById("addr_detail").value = remainingAddr.substring(matchedDist.length);
                } else {
                    document.getElementById("addr_detail").value = remainingAddr;
                }
            } else {
                document.getElementById("addr_detail").value = fullAddr;
            }
        }

        function saveData() {
            const btn = document.getElementById('btn-save');
            const name = document.getElementById('u_name').value;
            const phone = document.getElementById('u_phone').value;
            const birthday = document.getElementById('u_birthday').value;
            const memo = document.getElementById('u_memo').value;
            const email = document.getElementById('u_email').value; 
            const city = document.getElementById("addr_city").value;
            const dist = document.getElementById("addr_dist").value;
            const detail = document.getElementById("addr_detail").value;
            
            let fullAddr = "";
            if(city && dist) {
                fullAddr = city + dist + detail;
            } else if (detail) {
                fullAddr = detail; 
            }
            
            const marketing = document.getElementById('u_marketing').checked ? 1 : 0;

            if(!name) { 
                showCustomAlert('客戶名稱讀取失敗，請重新開啟頁面'); 
                return; 
            }
            if(!phone) { 
                showCustomAlert('請輸入電話 (必填)'); 
                return; 
            }
            if(!city || city === "") { 
                showCustomAlert('請選擇縣市'); 
                return; 
            }
            if(!dist || dist === "") { 
                showCustomAlert('請選擇區域'); 
                return; 
            }

            btn.disabled = true;
            btn.innerText = '儲存中...';

            const params = `?action=save` +
                           `&u_id=${encodeURIComponent(currentUserId)}` +
                           `&name=${encodeURIComponent(name)}` +
                           `&phone=${encodeURIComponent(phone)}` +
                           `&addr=${encodeURIComponent(fullAddr)}` +
                           `&email=${encodeURIComponent(email)}` +  
                           `&birthday=${encodeURIComponent(birthday)}` +
                           `&marketing=${marketing}` + 
                           `&memo=${encodeURIComponent(memo)}`;

            fetch(GAS_URL + params)
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    showCustomAlert(result.message);
                } else {
                    showCustomAlert('存檔失敗: ' + result.message);
                    btn.disabled = false;
                    btn.innerText = '存檔';
                }
            })
            .catch(err => {
                showCustomAlert('存檔發生錯誤: ' + err);
                btn.disabled = false;
                btn.innerText = '存檔';
            });
        }

        /* --- 彈窗控制函式 --- */
        function showCustomAlert(msg) {
            document.getElementById('modal-message').innerText = msg;
            document.getElementById('myModal').style.display = 'flex';
        }

        function closeAndExit() {
            document.getElementById('myModal').style.display = 'none';
            // 若存檔成功則關閉視窗，若只是普通警告則可不關閉（視需求調整）
            if (document.getElementById('modal-message').innerText === '會員資料已更新') {
                liff.closeWindow();
            }
        }
    </script>
</body>
</html>

