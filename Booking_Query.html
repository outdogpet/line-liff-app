<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ç´„æŸ¥è©¢</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary-color: #2e86de; --bg-color: #f1f2f6; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg-color); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .list-container { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 12px; }
        /* å¢åŠ æ‰‹å‹¢æŒ‡å¼•ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“å¯ä»¥é»æ“Š */
        .booking-card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 6px solid var(--primary-color); cursor: pointer; transition: 0.2s; }
        .booking-card:active { transform: scale(0.98); }
        .card-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; }
        .date-badge { font-weight: 700; color: var(--primary-color); font-size: 16px; }
        .info-row { font-size: 14px; margin: 5px 0; color: #2f3542; display: flex; justify-content: space-between; }
        .label { color: #a4b0be; }
        .val { font-weight: 500; }
        .cancel-btn { width: 100%; border: none; padding: 10px; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; transition: 0.3s; background: #ee5253; color: white; }
        .btn-disabled { background: #ced6e0; color: white; cursor: not-allowed; }
        .notice { font-size: 12px; color: #eb4d4b; text-align: center; margin-top: 8px; font-weight: bold; }
        #loading, #no-data { text-align: center; color: #747d8c; margin-top: 50px; display: none; }

        /* QR Code å½ˆçª—æ¨£å¼ */
        #qr-modal {
            display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center;
        }
        .qr-box { background: white; padding: 25px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; }
        .qr-box img { width: 100%; height: auto; margin: 15px 0; }
    </style>
</head>
<body>
    <h2 style="color: #2f3542;">ğŸ“… æˆ‘çš„é ç´„ç´€éŒ„</h2>
    <div id="loading">è®€å–è³‡æ–™ä¸­...</div>
    <div id="no-data">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é ç´„</div>
    <div class="list-container" id="list-area"></div>

    <div id="qr-modal" onclick="closeQR()">
        <div class="qr-box" onclick="event.stopPropagation()">
            <h3 style="margin:0; font-size: 18px;">é ç´„å–® QR Code</h3>
            <div id="qr-id-display" style="font-size: 12px; color: #747d8c; margin-top: 5px;"></div>
            <img id="qr-img" src="" alt="QR Code">
            <button class="cancel-btn" style="background:#2e86de;" onclick="closeQR()">é—œé–‰</button>
        </div>
    </div>

    <script>
        const LIFF_ID = '2009076774-iFPf2YqP';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbycJV_RoTxvkhOGFaE7zHZlenPpyimM-3J_DqeRjOPKM3dr7LnY0NpwrZ7OEFE61zjPmw/exec';
        let userId = "";

        window.onload = () => {
            liff.init({ liffId: LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) { liff.login(); } 
                else { liff.getProfile().then(p => { userId = p.userId; fetchData(); }); }
            });
        };

        function fetchData() {
            document.getElementById('loading').style.display = 'block';
            fetch(`${GAS_URL}?action=get_booking_history&u_id=${userId}`)
                .then(res => res.json()).then(res => {
                    document.getElementById('loading').style.display = 'none';
                    if (res.status === 'success' && res.data.length > 0) { render(res.data); } 
                    else { document.getElementById('no-data').style.display = 'block'; }
                });
        }

        /**
         * å½ˆå‡º QR Code è¦–çª—
         */
        function showQR(rId) {
            const qrUrl = `https://quickchart.io/qr?text=${encodeURIComponent(rId)}&size=250`;
            document.getElementById('qr-img').src = qrUrl;
            document.getElementById('qr-id-display').innerText = "å–®è™Ÿï¼š" + rId;
            document.getElementById('qr-modal').style.display = 'flex';
        }

        function closeQR() {
            document.getElementById('qr-modal').style.display = 'none';
        }

        function cancelBooking(event, rId) {
            event.stopPropagation(); // é‡é»ï¼šé˜²æ­¢é»æ“Šå–æ¶ˆæŒ‰éˆ•æ™‚è§¸ç™¼å¡ç‰‡çš„ showQR
            Swal.fire({
                title: 'ç¢ºå®šå–æ¶ˆï¼Ÿ',
                text: "é ç´„å–®è™Ÿï¼š" + rId,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ee5253',
                cancelButtonColor: '#747d8c',
                confirmButtonText: 'ç¢ºå®šå–æ¶ˆ',
                cancelButtonText: 'æš«ç•™é ç´„'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.showLoading();
                    fetch(`${GAS_URL}?action=cancel_booking&r_id=${rId}`)
                        .then(res => res.json()).then(res => {
                            if (res.status === 'success') {
                                Swal.fire('å·²å–æ¶ˆ', res.message, 'success').then(() => location.reload());
                            } else {
                                Swal.fire('éŒ¯èª¤', res.message, 'error');
                            }
                        });
                }
            });
        }

        function render(data) {
            const area = document.getElementById('list-area');
            area.innerHTML = data.map(item => {
                const isConfirmed = item.rConfirm == "1";
                return `
                <div class="booking-card" onclick="showQR('${item.rId}')">
                    <div class="card-header">
                        <div class="date-badge">${item.rDate} <small style="color:#747d8c">${item.startTime}</small></div>
                        <div style="font-size:11px; font-weight:bold; color:${isConfirmed?'#1976d2':'#f57c00'}">${isConfirmed?'åº—å®¶å·²ç¢ºèª':'å¾…ç¢ºèª'}</div>
                    </div>
                    <div class="info-row"><span class="label">é ç´„å–®è™Ÿ</span><span class="val">${item.rId}</span></div>
                    <div class="info-row"><span class="label">å¯µç‰©åç¨±</span><span class="val" style="color:#e67e22; font-weight:700;">${item.pName}</span></div>
                    
                    <button class="cancel-btn ${isConfirmed ? 'btn-disabled' : ''}" 
                            ${isConfirmed ? 'disabled' : ''} 
                            onclick="cancelBooking(event, '${item.rId}')">å–æ¶ˆé ç´„</button>
                    ${isConfirmed ? '<div class="notice">å¦‚éœ€å–æ¶ˆè«‹è¯çµ¡åº—å®¶ï¼Œè¬è¬!!</div>' : ''}
                </div>`;
            }).join('');
        }
    </script>
</body>
</html>
